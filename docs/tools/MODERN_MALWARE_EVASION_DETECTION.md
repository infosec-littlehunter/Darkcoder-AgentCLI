# Modern Malware Evasion Detection

## Overview

DarkCoder's reverse engineering tools now include **comprehensive detection** for modern malware evasion techniques used to bypass Windows Defender, EDR (Endpoint Detection & Response) systems, and security monitoring tools.

## ğŸ¯ What Can the LLM Detect?

### 1. **Direct Syscall / NTDLL Unhooking** (T1562.001)

**Why it matters:** Modern malware bypasses EDR hooks in `ntdll.dll` and `kernel32.dll` by making direct system calls or restoring original function bytes.

**Detection capabilities:**

- âœ… Direct syscall instructions (`syscall`, `sysenter`, `int 2e`)
- âœ… Syscall opcodes (`0F 05`, `0F 34`)
- âœ… System Service Number (SSN) resolution
- âœ… NTDLL unhooking APIs:
  - `NtProtectVirtualMemory` + `NtWriteVirtualMemory` (classic unhooking pattern)
  - `NtMapViewOfSection` / `NtUnmapViewOfSection` (fresh NTDLL mapping)
  - `NtReadVirtualMemory` (reading clean NTDLL from disk)
- âœ… Known syscall frameworks:
  - Hell's Gate / Halo's Gate / Tartarus' Gate
  - SysWhispers / FreshyCalls
- âœ… Heaven's Gate technique (32-bit â†’ 64-bit WoW64 transitions)

**Scoring system:**

- **Score â‰¥ 30/100:** HIGH confidence - Definitive syscall/unhooking evasion
- **Score â‰¥ 15/100:** MEDIUM confidence - Possible evasion

**Example output:**

```
ğŸ” SYSCALL & HOOK EVASION ANALYSIS:
   ğŸ”´ Direct syscall instruction (x64)
   ğŸ”´ NtProtectVirtualMemory - Change memory protection for unhooking
   ğŸ”´ NtWriteVirtualMemory - Write unhooked NTDLL
   ğŸ”´ CLASSIC UNHOOKING PATTERN DETECTED!
      â””â”€â”€ NtProtectVirtualMemory + NtWriteVirtualMemory
      â””â”€â”€ Likely restoring hooked functions

ğŸ”´ HIGH CONFIDENCE: DIRECT SYSCALL / UNHOOKING EVASION
   â””â”€â”€ Score: 55/100
   â””â”€â”€ Bypasses EDR/AV hooks in NTDLL/kernel32
   â””â”€â”€ MITRE: T1562.001 (Impair Defenses)

ğŸ’¡ ANALYSIS RECOMMENDATIONS:
   â€¢ Analyze with API Monitor or x64dbg to see actual syscalls
   â€¢ Check for SSN (System Service Number) lookup
   â€¢ Look for embedded syscall stubs (0x4c 0x8b 0xd1 0xb8...)
```

---

### 2. **AMSI Bypass** (T1562.001)

**Why it matters:** Anti-Malware Scan Interface (AMSI) scans scripts and in-memory payloads. Bypassing it allows malicious PowerShell/VBA/JScript to run undetected.

**Detection capabilities:**

- âœ… AMSI function references:
  - `AmsiScanBuffer` (most common patch target)
  - `AmsiScanString`
  - `AmsiInitialized`
- âœ… AMSI error codes:
  - `0x80070057` (E_INVALIDARG - common bypass return value)
  - `0x8007` patterns
- âœ… Memory patching APIs used with AMSI:
  - `VirtualProtect` + AMSI strings
  - `WriteProcessMemory` + AMSI strings
  - `NtProtectVirtualMemory` + AMSI strings

**Common bypass techniques detected:**

1. **Memory patching:** Overwriting `AmsiScanBuffer` with `0xB8 0x57 0x00 0x07 0x80 0xC3` (mov eax, 0x80070057; ret)
2. **Context manipulation:** Setting `amsiContext` to null
3. **Initialization failure:** Forcing AMSI_RESULT_NOT_DETECTED
4. **Reflection abuse:** PowerShell reflection to access `AmsiUtils`

**Scoring:**

- **Score â‰¥ 25/100:** HIGH confidence
- **Score â‰¥ 10/100:** MEDIUM confidence

---

### 3. **ETW Bypass** (T1562.001, T1070)

**Why it matters:** Event Tracing for Windows (ETW) provides telemetry to EDRs, Sysmon, and security monitoring. Disabling it blinds defenders.

**Detection capabilities:**

- âœ… ETW function references:
  - `EtwEventWrite` (primary patch target)
  - `NtTraceControl` (programmatic control)
- âœ… ETW providers:
  - ETW Threat Intelligence (ETWTI) provider
  - `Microsoft-Windows-Threat-Intelligence`
- âœ… Common patch signatures:
  - `0xC3` (RET opcode - simplest ETW patch)
- âœ… Memory patching APIs

**Common bypass techniques detected:**

1. **Function patching:** Replace `EtwEventWrite` with `0xC3` (ret)
2. **Provider disabling:** Disable ETW TI provider
3. **Trace session control:** `NtTraceControl` to stop sessions
4. **Impact:** Prevents .NET ETW, PowerShell script block logging, Sysmon events

**Scoring:**

- **Score â‰¥ 25/100:** HIGH confidence
- **Score â‰¥ 10/100:** MEDIUM confidence

---

### 4. **Sleep Obfuscation** (T1497.003) **[NEW]**

**Why it matters:** Modern C2 beacons (Cobalt Strike, Brute Ratel, Sliver) encrypt their memory during sleep to avoid detection by memory scanners.

**Detection capabilities:**

- âœ… Named techniques:
  - **Ekko:** ROP-based sleep obfuscation with encryption
  - **Zilean:** Thread-based sleep masking
  - **Foliage:** Queue-based sleep technique
- âœ… Timer-based sleep:
  - `CreateTimerCallback`
  - `SetWaitableTimer`
  - `RtlCreateTimer`
- âœ… Encryption during sleep:
  - `CryptEncrypt` + sleep patterns
  - `RtlEncryptMemory` + sleep patterns

**Purpose:**

- Encrypt beacon memory while sleeping (no plaintext strings in RAM)
- Use legitimate Windows timers instead of suspicious `Sleep()`
- Prevents EDR memory scanning from finding IOCs

**Scoring:**

- **Score â‰¥ 20/100:** Detection confirmed

---

### 5. **API Hashing** (T1027, T1106) **[NEW]**

**Why it matters:** Hides API imports from static analysis. Instead of importing `CreateRemoteThread` (obvious malware indicator), hash the name and resolve dynamically.

**Detection capabilities:**

- âœ… Hashing algorithms:
  - **ROR13 hash** (most common in shellcode)
  - **CRC32**
  - **FNV1a**
  - **DJB2**
- âœ… PEB walking:
  - `PEB` (Process Environment Block) references
  - `InLoadOrderModuleList` (manual DLL enumeration)
  - PEB walk **without** `LoadLibrary` (highly suspicious)
- âœ… Dynamic resolution:
  - `GetProcAddress` + hashing algorithms
  - `LoadLibrary` + hashing

**Common patterns:**

1. Walk PEB to find `kernel32.dll` / `ntdll.dll`
2. Hash API names (e.g., `CreateRemoteThread` â†’ `0x1234ABCD`)
3. Compare hashes to find functions
4. Call without importing

**Used by:**

- Metasploit payloads
- Cobalt Strike beacons
- APT malware (Lazarus, APT29)

**Scoring:**

- **Score â‰¥ 25/100:** HIGH confidence
- Manual PEB walk without LoadLibrary: +25 points (instant HIGH)

---

### 6. **Module Stomping / Phantom DLL Loading** (T1055.013, T1574.002) **[NEW]**

**Why it matters:** Load a legitimate DLL (e.g., `mshtml.dll`), then overwrite its memory with malicious code. EDR sees "mshtml.dll loaded" (benign), but the actual code is malicious.

**Detection capabilities:**

- âœ… Module stomping APIs:
  - `NtMapViewOfSection` + `NtWriteVirtualMemory` + `NtUnmapViewOfSection` (stomping pattern)
- âœ… Advanced techniques:
  - **Phantom DLL loading:** Map DLL without file on disk
  - **Process DoppelgÃ¤nging:** Transacted NTFS abuse
- âœ… Explicit strings:
  - "module stomp"
  - "phantom dll"
  - "doppelganging"
  - "transacted"

**How it works:**

1. Map legitimate DLL into memory (`NtMapViewOfSection`)
2. Write malicious code over it (`NtWriteVirtualMemory`)
3. Optionally unmap original (`NtUnmapViewOfSection`)
4. Execute malicious code under legitimate module name

**Bypasses:**

- EDR hooks (code runs in "trusted" module)
- Application whitelisting
- Code integrity checks

**Scoring:**

- **Score â‰¥ 25/100:** HIGH confidence

---

## ğŸ”§ How to Use

### Command-line usage:

```bash
darkcoder reverse-engineering capability_analysis malware.exe
```

### Expected output:

```
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
               MALWARE CAPABILITY ANALYSIS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Target: malware.exe
Detected Capabilities: 8

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ğŸ›¡ï¸  DEFENSE EVASION (TA0005)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ” SYSCALL & HOOK EVASION ANALYSIS:
   ğŸ”´ Direct syscall instruction (x64)
   ğŸ”´ System Service Number
   ğŸ”´ NtProtectVirtualMemory - Change memory protection
   ğŸ”´ MANUAL SYSCALL IMPLEMENTATION!
      â””â”€â”€ System Service Number (SSN) resolution
      â””â”€â”€ Direct syscall without NTDLL

ğŸ”´ HIGH CONFIDENCE: DIRECT SYSCALL / UNHOOKING EVASION
   â””â”€â”€ Score: 45/100

ğŸ” AMSI BYPASS ANALYSIS:
   ğŸ”´ AmsiScanBuffer (patch target)
   ğŸ”´ VirtualProtect - Memory patching API

ğŸ”´ HIGH CONFIDENCE: AMSI BYPASS DETECTED
   â””â”€â”€ Score: 35/100

ğŸ” SLEEP OBFUSCATION / TIME-BASED EVASION:
   ğŸ”´ Ekko sleep obfuscation
   ğŸ”´ Encryption + sleep (memory obfuscation during sleep)

ğŸ”´ SLEEP OBFUSCATION DETECTED
   â””â”€â”€ Score: 35/100
   â””â”€â”€ MITRE: T1497.003
```

---

## ğŸ§  What This Means for LLM Analysis

### âœ… **YES - LLM CAN NOW DETECT:**

1. **Modern C2 Beacons:**
   - Cobalt Strike with Ekko/Zilean sleep obfuscation
   - Brute Ratel C4 with syscalls
   - Sliver with AMSI/ETW bypass
   - Metasploit Meterpreter with API hashing

2. **APT Malware:**
   - Direct syscalls (Lazarus, APT29, APT28)
   - Heaven's Gate (advanced Chinese/Russian APTs)
   - Module stomping (Turla, FIN7)

3. **EDR Evasion Techniques:**
   - NTDLL unhooking
   - ETW Threat Intelligence bypass
   - AMSI patching
   - Sleep obfuscation

4. **Obfuscation Methods:**
   - API hashing (ROR13, CRC32, FNV1a)
   - PEB walking
   - Dynamic API resolution

### âŒ **Limitations:**

1. **Encrypted/Packed Malware:**
   - Must be unpacked first
   - Use `unpack` operation before `capability_analysis`

2. **Polymorphic Code:**
   - May generate different hashes/patterns each execution
   - LLM looks for technique patterns, not exact signatures

3. **Zero-Day Techniques:**
   - Unknown evasion methods won't be detected
   - System is updated based on public research

---

## ğŸ“Š Scoring System Explained

Each evasion category uses a **scoring system** to determine confidence:

| Score Range | Confidence | Meaning                                |
| ----------- | ---------- | -------------------------------------- |
| 0-14        | LOW/NONE   | No indicators or very weak             |
| 15-24       | MEDIUM     | Some indicators, needs deeper analysis |
| 25+         | HIGH       | Strong evidence, likely malicious      |

**Score components:**

- **HIGH confidence pattern:** +15 points
- **MEDIUM confidence pattern:** +10 points
- **LOW confidence pattern:** +3-5 points
- **API combination pattern:** +20-25 points (e.g., NtProtectVirtualMemory + NtWriteVirtualMemory)

---

## ğŸš€ Real-World Examples

### Example 1: Cobalt Strike Beacon with Ekko

```bash
$ darkcoder reverse-engineering capability_analysis beacon.dll
```

**Detected:**

- âœ… Sleep obfuscation (Ekko) - Score: 35/100
- âœ… Syscall evasion - Score: 45/100
- âœ… AMSI bypass - Score: 30/100
- âœ… ETW bypass - Score: 25/100

**MITRE ATT&CK:**

- T1562.001 (Impair Defenses)
- T1497.003 (Time-Based Evasion)
- T1055 (Process Injection via syscalls)

---

### Example 2: Metasploit Meterpreter

```bash
$ darkcoder reverse-engineering capability_analysis meterpreter.exe
```

**Detected:**

- âœ… API hashing (ROR13) - Score: 40/100
- âœ… Reflective DLL loading
- âœ… PEB walking without LoadLibrary

**MITRE ATT&CK:**

- T1027 (Obfuscated Files or Information)
- T1106 (Native API)
- T1620 (Reflective Code Loading)

---

### Example 3: APT Malware with Heaven's Gate

```bash
$ darkcoder reverse-engineering capability_analysis apt_malware.exe
```

**Detected:**

- âœ… Heaven's Gate technique - Score: 65/100
- âœ… Module stomping - Score: 40/100
- âœ… Direct syscalls (WoW64 transition)

**MITRE ATT&CK:**

- T1562.001 (Impair Defenses - Heaven's Gate)
- T1055.013 (Process DoppelgÃ¤nging)

---

## ğŸ”¬ Technical Deep Dive

### How Syscall Detection Works:

1. **Pattern matching:**

   ```assembly
   mov r10, rcx        ; Windows syscall ABI
   mov eax, 0x0018     ; System Service Number (SSN)
   syscall             ; Direct syscall instruction
   ret
   ```

   - Looks for: `syscall`, `0x0018` (SSN), `mov r10, rcx`

2. **API pattern analysis:**

   ```c
   // Classic unhooking
   NtProtectVirtualMemory(ntdll_base, PAGE_EXECUTE_READWRITE);
   memcpy(ntdll_base, clean_ntdll, size);  // Restore original bytes
   NtProtectVirtualMemory(ntdll_base, PAGE_EXECUTE_READ);
   ```

   - Detects: Combined use of `NtProtectVirtualMemory` + write operations

3. **String analysis:**
   - Known frameworks: "hell's gate", "syswhisper", "freshycalls"
   - NTDLL references without normal API usage

---

### How AMSI Bypass Detection Works:

**Classic memory patch:**

```assembly
; AmsiScanBuffer patch
mov eax, 0x80070057    ; E_INVALIDARG
ret                    ; Return immediately (0xC3)
```

**Detected by:**

- `AmsiScanBuffer` string + `0x80070057` constant
- `VirtualProtect` + `amsi.dll` references
- Score: 15 (AMSI func) + 15 (error code) + 10 (VirtualProtect) = **40/100 HIGH**

---

### How Sleep Obfuscation Detection Works:

**Ekko technique:**

```c
// Encrypt beacon memory
RtlEncryptMemory(beacon_base, beacon_size, 0);

// Sleep via timer (not Sleep())
CreateWaitableTimer(...);
SetWaitableTimer(..., sleep_time, ...);
WaitForSingleObject(...);

// Decrypt on wake
RtlEncryptMemory(beacon_base, beacon_size, 0);
```

**Detected by:**

- "ekko" string + encryption API + timer functions
- Score: 15 (ekko) + 20 (encryption + sleep) = **35/100 HIGH**

---

## ğŸ› ï¸ Integration with Other Tools

### Combine with other operations:

```bash
# Full analysis pipeline
darkcoder reverse-engineering \
  malware_triage sample.exe \
  anti_analysis sample.exe \
  capability_analysis sample.exe \
  yara_generate sample.exe
```

**Result:**

- **malware_triage:** Threat score, basic classification
- **anti_analysis:** VM/debugger checks
- **capability_analysis:** Evasion techniques (syscalls, AMSI, ETW, sleep obfuscation, etc.)
- **yara_generate:** Custom YARA rule with all IOCs

---

## ğŸ“š References

### Research Papers & Techniques:

1. **Direct Syscalls:**
   - [SysWhispers](https://github.com/jthuraisamy/SysWhispers) - Syscall stub generation
   - [Hell's Gate](https://vxug.fakedoma.in/papers/VXUG/Exclusive/HellsGate.pdf) - SSN extraction
   - [Halo's Gate](https://blog.sektor7.net/#!res/2021/halosgate.md) - Improved Hell's Gate

2. **Sleep Obfuscation:**
   - [Ekko](https://github.com/Cracked5pider/Ekko) - Sleep obfuscation via ROP
   - [Zilean](https://github.com/Idov31/Cronos/tree/master/Zilean) - Thread-based sleep

3. **AMSI Bypass:**
   - [AMSI.fail](https://amsi.fail/) - AMSI bypass database
   - [Memory patching techniques](https://rastamouse.me/memory-patching-amsi-bypass/)

4. **Module Stomping:**
   - [Process DoppelgÃ¤nging](https://www.blackhat.com/docs/eu-17/materials/eu-17-Liberman-Lost-In-Transaction-Process-Doppelganging.pdf)
   - [Phantom DLL Loading](https://www.elastic.co/blog/process-ghosting-a-new-executable-image-tampering-attack)

5. **Heaven's Gate:**
   - [Heaven's Gate Technique](https://vxheaven.org/lib/pdf/Heavens%20Gate.pdf)
   - 32-bit â†’ 64-bit transitions on WoW64

---

## âš ï¸ Ethical Use

This detection system is designed for:

- âœ… Malware analysis and research
- âœ… Red team/purple team exercises
- âœ… Security training and education
- âœ… Incident response investigations
- âœ… Threat hunting

**NOT for:**

- âŒ Creating malware
- âŒ Evading detection in malicious activities
- âŒ Unauthorized system access

---

## ğŸ“ Training the LLM

When the LLM analyzes malware:

1. **It understands the context:**
   - "This binary uses direct syscalls (score: 45/100)"
   - "Likely Cobalt Strike beacon based on Ekko sleep obfuscation"

2. **It provides actionable insights:**
   - "Recommend analyzing with API Monitor to trace syscalls"
   - "Check for SSN lookup routine in .text section"
   - "Examine memory encryption during sleep"

3. **It maps to MITRE ATT&CK:**
   - T1562.001 (Impair Defenses)
   - T1497.003 (Time-Based Evasion)
   - T1027 (Obfuscated Files)

4. **It explains bypass impact:**
   - "AMSI bypass allows malicious PowerShell to run undetected"
   - "ETW bypass blinds EDR telemetry and Sysmon"
   - "Sleep obfuscation prevents memory scanning"

---

## ğŸ”„ Future Enhancements

Planned additions:

- [ ] Stack spoofing detection
- [ ] Return-oriented programming (ROP) chains
- [ ] Control flow guard (CFG) bypass
- [ ] Kernel callback removal
- [ ] PPID spoofing detection
- [ ] Hardware breakpoint detection
- [ ] Instrumentation callback detection

---

## ğŸ“– Summary

**Question:** _"Can our reverse engineer tools help the LLM detect modern malware that uses syscalls and advanced techniques to evade Windows Defender?"_

**Answer:** **YES!** âœ…

The LLM now has **comprehensive detection** for:

1. âœ… Direct syscalls & NTDLL unhooking
2. âœ… AMSI bypass (script scanning evasion)
3. âœ… ETW bypass (telemetry blindness)
4. âœ… Sleep obfuscation (Ekko, Zilean, Foliage)
5. âœ… API hashing (import hiding)
6. âœ… Module stomping (DLL masquerading)
7. âœ… Heaven's Gate (WoW64 evasion)
8. âœ… Reflective DLL loading
9. âœ… PEB walking
10. âœ… Known evasion frameworks (SysWhispers, Hell's/Halo's Gate)

Each technique is:

- **Scored** for confidence (HIGH/MEDIUM/LOW)
- **Mapped** to MITRE ATT&CK
- **Explained** with technical details
- **Contextualized** with real-world examples

The LLM can now analyze modern APT malware, C2 beacons, and EDR evasion techniques with expert-level understanding.
