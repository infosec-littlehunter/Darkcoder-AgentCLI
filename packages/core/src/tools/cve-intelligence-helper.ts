/**
 * @license
 * Copyright 2025 DarkCoder
 * SPDX-License-Identifier: Apache-2.0
 */

/**
 * CVE Intelligence Helper
 *
 * Shared helper functions for adding live CVE/vulnerability intelligence
 * to security tools. This addresses the LLM limitation of training data cutoff.
 */

export interface DetectedProduct {
  name: string;
  version?: string;
  vendor?: string;
  confidence: 'high' | 'medium' | 'low';
  source: string; // Where it was detected from
}

export interface CVERecommendation {
  action: string;
  tool: string;
  params?: Record<string, unknown>;
  description: string;
}

/**
 * ğŸ”’ MEMORY SAFETY: Absolute maximum limits to prevent heap overflow
 * These are hard limits that cannot be exceeded regardless of input
 */
const ABSOLUTE_MAX_PRODUCTS = 50;
const ABSOLUTE_MAX_OUTPUT_LENGTH = 100000; // 100KB max output

/**
 * Safely limit products array with absolute maximum enforcement
 * This prevents any possibility of unbounded growth
 */
function safelyLimitProducts(products: DetectedProduct[]): DetectedProduct[] {
  if (!Array.isArray(products)) return [];
  if (products.length === 0) return [];

  // Hard limit enforcement
  const limited = products.slice(0, ABSOLUTE_MAX_PRODUCTS);

  // Validate each product to prevent malformed data
  return limited.filter(
    (p) =>
      p &&
      typeof p.name === 'string' &&
      p.name.length > 0 &&
      p.name.length < 500, // Prevent extremely long product names
  );
}

/**
 * Generate CVE check recommendations based on detected products
 */
export function generateCVERecommendations(
  products: DetectedProduct[],
): string {
  // ğŸ”’ MEMORY SAFETY: Use safe wrapper with absolute limits
  const safeProducts = safelyLimitProducts(products);

  // ğŸ”’ MEMORY OPTIMIZATION: Limit products to prevent huge output
  const MAX_DISPLAY_PRODUCTS = 15;
  const limitedProducts = safeProducts.slice(0, MAX_DISPLAY_PRODUCTS);
  const hasMore = safeProducts.length > MAX_DISPLAY_PRODUCTS;

  const output: string[] = [];

  output.push(
    '\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—',
  );
  output.push(
    'â•‘   ğŸŒ LIVE CVE INTELLIGENCE - Beyond LLM Training Data         â•‘',
  );
  output.push(
    'â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n',
  );

  if (products.length === 0) {
    output.push('  âš ï¸  No specific product versions detected for CVE lookup\n');
    output.push(
      '  ğŸ’¡ TIP: Use vulnerability_db tool for manual CVE research\n',
    );
    return output.join('\n');
  }

  output.push(
    `ğŸ“Š DETECTED PRODUCTS (${limitedProducts.length}${hasMore ? ` of ${products.length} total` : ''}):\n`,
  );
  for (const prod of limitedProducts) {
    const conf =
      prod.confidence === 'high'
        ? 'âœ…'
        : prod.confidence === 'medium'
          ? 'âš¡'
          : 'âš ï¸';
    output.push(
      `  ${conf} ${prod.name}${prod.version ? ` v${prod.version}` : ''}`,
    );
    output.push(`     Source: ${prod.source}\n`);
  }

  if (hasMore) {
    output.push(
      `\n  âš ï¸  Showing top ${MAX_DISPLAY_PRODUCTS} products (memory optimized)\n`,
    );
  }

  output.push('\nğŸ¯ RECOMMENDED CVE CHECKS:\n');
  output.push(
    '  Use these commands to get LIVE vulnerability data (not LLM predictions):\n\n',
  );

  let cmdNum = 1;
  const MAX_COMMANDS = 10; // Limit command output
  const highConfProducts = limitedProducts
    .filter((p) => p.confidence !== 'low')
    .slice(0, MAX_COMMANDS);
  for (const prod of highConfProducts) {
    if (prod.version) {
      output.push(`  ${cmdNum}. vulnerability_db(`);
      output.push(`       operation="product",`);
      output.push(`       product="${prod.name}",`);
      output.push(`       vendor="${prod.vendor || prod.name}",`);
      output.push(`       severity="high"  // or "critical" for urgent issues`);
      output.push(`     )\n`);
      cmdNum++;
    } else {
      output.push(`  ${cmdNum}. vulnerability_db(`);
      output.push(`       operation="search",`);
      output.push(
        `       query="${prod.name}"  // Find CVEs mentioning this product`,
      );
      output.push(`     )\n`);
      cmdNum++;
    }
  }

  output.push('\nğŸ“š WHY LIVE CVE CHECKS MATTER:\n\n');
  output.push('  âŒ LLM Training Data:\n');
  output.push('     â€¢ Knowledge cutoff (e.g., July 2024)\n');
  output.push('     â€¢ Cannot know CVEs discovered after training\n');
  output.push('     â€¢ Provides "based on similar patterns" analysis\n\n');

  output.push('  âœ… Live CVE Database (NVD):\n');
  output.push('     â€¢ Real-time queries to nvd.nist.gov\n');
  output.push('     â€¢ CVEs published THIS WEEK or even TODAY\n');
  output.push('     â€¢ Actual CVSS scores, not predictions\n');
  output.push('     â€¢ Exploit availability status\n');
  output.push('     â€¢ Vendor patch information\n\n');

  output.push('âš¡ CROSS-REFERENCE RECOMMENDATIONS:\n\n');
  output.push('  1. Check Exploit-DB:\n');
  output.push(
    '     vulnerability_db(operation="exploit", query="<product>")\n\n',
  );

  output.push('  2. Query threat intelligence:\n');
  output.push(
    '     virustotal(operation="url_scan", url="<detected_url>")\n\n',
  );

  output.push('  3. Check vendor advisories:\n');
  output.push(
    '     Use reverse_engineering(operation="vendor_advisories")\n\n',
  );

  output.push('  4. Recent attack patterns:\n');
  output.push('     Use reverse_engineering(operation="recent_attacks")\n\n');

  const result = output.join('\n');

  // ğŸ”’ FINAL SAFETY: Truncate if output exceeds absolute maximum
  if (result.length > ABSOLUTE_MAX_OUTPUT_LENGTH) {
    return (
      result.substring(0, ABSOLUTE_MAX_OUTPUT_LENGTH) +
      '\n\nâš ï¸  Output truncated for memory safety'
    );
  }

  return result;
}

/**
 * Generate comparison between LLM knowledge and live intelligence
 */
export function generateLLMvsLiveComparison(): string {
  return `
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘        LLM TRAINING DATA vs LIVE VULNERABILITY INTELLIGENCE    â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“Š CAPABILITY COMPARISON:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Capability              â”‚ LLM Training Data â”‚ Live Intelligenceâ”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ CVE Discovery Date      â”‚ Up to ~July 2024  â”‚ Real-time/Today  â”‚
â”‚ Exploit Availability    â”‚ Predicted/Guessed â”‚ Actual Status    â”‚
â”‚ Patch Status            â”‚ Unknown           â”‚ Current Status   â”‚
â”‚ CVSS Scores             â”‚ Historical only   â”‚ Latest scores    â”‚
â”‚ Vendor Advisories       â”‚ Outdated          â”‚ Current bulletinsâ”‚
â”‚ Attack Campaigns        â”‚ Historical        â”‚ Active now       â”‚
â”‚ PoC Availability        â”‚ Speculation       â”‚ Confirmed links  â”‚
â”‚ CISA KEV Status         â”‚ Unknown           â”‚ Real-time        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ’¡ RECOMMENDED WORKFLOW:

  Step 1: Use LLM for pattern analysis
    â€¢ Identify technology stack
    â€¢ Recognize attack patterns
    â€¢ Suggest investigation areas

  Step 2: Use live tools for current status
    â€¢ vulnerability_db for actual CVEs
    â€¢ virustotal for threat verdicts
    â€¢ censys for infrastructure intelligence

  Step 3: Combine insights
    â€¢ LLM explains attack vectors
    â€¢ Live data confirms exploitation status
    â€¢ Prioritize based on actual risk

ğŸ¯ EXAMPLE SCENARIO:

  Detected: nginx 1.18.0

  LLM Response:
    "nginx 1.18.0 may have known vulnerabilities. Based on patterns
     from my training data (July 2024), I suggest checking for CVEs."

  Live CVE Check:
    vulnerability_db(operation="product", product="nginx", version="1.18.0")
    â†’ Returns: CVE-2024-XXXXX (published Nov 2024, CRITICAL)
    â†’ Exploit: Public PoC available on GitHub (Dec 2024)
    â†’ Status: Actively exploited according to CISA KEV

âš ï¸  CRITICAL DIFFERENCE:
    LLM can't know about CVE-2024-XXXXX (published after training).
    Live check provides actionable, current intelligence.
`;
}

/**
 * Parse version strings from various formats
 */
export function parseVersion(versionString: string): string | undefined {
  const patterns = [
    /v?(\d+\.\d+\.\d+)/i, // v1.2.3 or 1.2.3
    /version[:\s]+(\d+\.\d+\.\d+)/i, // version: 1.2.3
    /(\d+\.\d+)/, // 1.2
  ];

  for (const pattern of patterns) {
    const match = versionString.match(pattern);
    if (match) {
      return match[1];
    }
  }

  return undefined;
}

/**
 * Format CVE intelligence section for tool outputs
 */
export function formatCVEIntelligenceSection(
  detectedProducts: DetectedProduct[],
  includeComparison: boolean = false,
): string {
  const recommendations = generateCVERecommendations(detectedProducts);

  if (includeComparison) {
    return recommendations + '\n' + generateLLMvsLiveComparison();
  }

  return recommendations;
}
